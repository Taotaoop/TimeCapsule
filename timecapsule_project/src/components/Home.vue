<template>
  <main>
    <section class="container" style="overflow: hidden">
      <div class="timeContentPar">
        <div
          class="box"
          :style="{ transform: 'translateX(' + position + 'px)' }"
        >
          <div class="timeContent">
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type2">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1947.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="content">香港工业专门学院</p>
              </div>
              <div class="img">
                <img
                  src="../assets/Timeline/history_1947(1).jpg"
                  width="100%"
                  alt=""
                />
              </div>
            </div>
            <div class="item type3">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1994_1.jpg"
                  width="100%"
                  alt=""
                />
                <div class="text">
                  <p class="title">香港理工大学</p>
                  <p class="content">
                    学院获大学及理工教育资助委员会颁授自我评审资格，正式取得大学地位，并正名为香港理工大学。
                  </p>
                </div>
              </div>
              <div class="img">
                <img
                  src="../assets/Timeline/history_1994_2.jpg"
                  width="100%"
                  alt=""
                />
                <div class="text">
                  <p class="title">包玉刚图书馆</p>
                  <p class="content">1996年的包玉刚图书馆命名仪式</p>
                </div>
              </div>
            </div>
            <div class="item type3">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1994_3.jpg"
                  width="100%"
                  alt=""
                />
                <div class="text">
                  <p class="title">毕业季</p>
                  <p class="content">我们毕业啦</p>
                </div>
              </div>
              <div class="text">
                <p class="title">毕业快乐( •̀ ω •́ )</p>
              </div>
            </div>
            <div class="item type3">
              <div class="img">
                <img
                  src="../assets/Timeline/history_today_2.jpg"
                  width="100%"
                  alt=""
                />
                <div class="text">
                  <p class="title">今天的香港理工大学</p>
                  <p class="content">
                    虽然理大有八十年的悠长历史，但我们一直与时并进，致力应对现实生活问题，造福香港、国家和全世界。
                  </p>
                </div>
              </div>
            </div>
            <!-- // -->
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <div class="item type1">
              <div class="img">
                <img
                  src="../assets/Timeline/history_1937.jpg"
                  width="100%"
                  alt=""
                />
              </div>
              <div class="text">
                <p class="title">香港官立高级工业学院成立</p>
                <p class="content">
                  校舍位于湾仔活道，是本校最早的前身，也是香港第一所由政府资助，提供专上程度工科教育的院校。
                </p>
              </div>
            </div>
            <!-- // -->
          </div>
        </div>
      </div>
      <TimeAxis @changePosition="changePosition" />
    </section>
    <div class="right">
      <div class="rightImage-wrapper">
        <img src="../assets/TimeCapsulePic/TimeCap2.png" alt="" width="100%" />
        <div class="button">
          
          <a-button @click="goToLogin">Go to Login</a-button>

          <a-button type="primary" @click="showModal"
            >Write Your Capsule</a-button
          >
        </div>
      </div>
    </div>
    <a-modal
      ref="modalRef"
      v-model:open="open"
      :wrap-style="{ overflow: 'hidden' }"
      width="800px"
    >
      <template #footer>
        <a-button key="back" @click="handleCancel">Cancel</a-button>
        <a-button
          :disabled="disabled"
          key="submit"
          type="primary"
          @click="handleOk"
          >Submit</a-button
        >
      </template>
      <a-form
        ref="formRef"
        :model="formState"
        v-bind="layout"
        name="nest-messages"
        :validate-messages="validateMessages"
        @finish="onFinish"
      >
        <a-form-item
          :name="['user', 'name']"
          label="Name"
          :rules="[{ required: true, whitespace: true }]"
        >
          <a-input v-model:value="formState.user.name">
            <template #suffix>
              <a-tooltip title="Extra information">
                <info-circle-outlined style="color: rgba(0, 0, 0, 0.45)" />
              </a-tooltip>
            </template>
          </a-input>
        </a-form-item>
        <a-form-item
          :name="['user', 'email']"
          label="Email"
          :rules="[{ type: 'email' }, { required: true }]"
        >
          <a-input v-model:value="formState.user.email" />
        </a-form-item>

        <a-form-item :name="['user', 'capsuleText']" label="CapsuleText">
          <a-textarea
            :auto-size="{ minRows: 5, maxRows: 8 }"
            v-model:value="formState.user.capsuleText"
            show-count
            :maxlength="100"
          />
        </a-form-item>
        <!-- Authorize to upload to timeline -->
        <a-form-item
          :name="['user', 'SubmitToTimeline']"
          label="Submit to Timeline"
          class="timeline-option"
        >
          <div class="timeline-controls">
            <a-space>
              <a-switch
                v-model:checked="formState.user.SubmitToTimeline"
                checked-children="Y"
                un-checked-children="N"
              />
              <a-tooltip>
                <template #title
                  >We will display your timecapsule on the public
                  timeline!</template
                >
                <QuestionCircleOutlined
                  style="font-size: 18px; position: relative; top: 3px"
                />
              </a-tooltip>
            </a-space>
          </div>
        </a-form-item>
        <a-form-item
          v-if="formState.user.SubmitToTimeline"
          :name="['user', 'publishDate']"
          label="Publish Date"
          :rules="[{ required: true, date: true }]"
        >
          <a-date-picker
            v-if="formState.user.SubmitToTimeline"
            v-model:value="formState.user.publishDate"
            type="date"
            placeholder="Pick a date"
            format="YYYY-MM-DD"
            value-format="YYYY-MM-DD"
          />
        </a-form-item>
        <a-upload-dragger
          v-model:fileList="fileList"
          name="file"
          :multiple="true"
          :max-count="3"
          action="http://localhost:3000/api/file-upload"
          :before-upload="beforeUpload"
          @change="handleChange"
          @drop="handleDrop"
        >
          <p class="ant-upload-drag-icon">
            <inbox-outlined />
          </p>
          <p class="ant-upload-text">
            Click or drag file to this area to upload
          </p>
          <p class="ant-upload-hint">
            Support pictures and .Zip file, Maximum 3
          </p>
        </a-upload-dragger>
      </a-form>
      <template #title>
        <div ref="modalTitleRef" style="width: 100%; cursor: move">
          Write Your Own Timecapsule
        </div>
      </template>
      <template #modalRender="{ originVNode }">
        <div :style="transformStyle">
          <component :is="originVNode" />
        </div>
      </template>
    </a-modal>
  </main>
</template>

<script setup>
import { ref, computed, watch, watchEffect, reactive } from "vue";
import { message, Upload } from "ant-design-vue";
import {
  InboxOutlined,
  InfoCircleOutlined,
  QuestionCircleOutlined,
} from "@ant-design/icons-vue";
import { onKeyDown, useDraggable } from "@vueuse/core";
import { uploadform } from "../api/writeTimecap";
import { useRouter } from "vue-router";
import TimeAxis from "./TimeAxis.vue";
//Timeline Module
const position = ref(0);
const changePosition = (e) => {
  const thumbnailToLargeRatio = 930 / 170;
  // 根据拖动的方向调整大图的位置
  position.value = -(e.x * thumbnailToLargeRatio);
};
//Dialog Module
const open = ref(false);
const modalTitleRef = ref(null);
const showModal = () => {
  open.value = true;
};
const { x, y, isDragging } = useDraggable(modalTitleRef);
const formRef = ref();
const handleOk = (e) => {
  formRef.value
    .validate()
    .then((formData) => {
      const data = {
        ...formData,
        fileList: fileList.value.map((item) => item.response),
      };
      console.log(data);
      // Clear form data before cancel
      formRef.value.resetFields();
      open.value = false;
      return uploadform(data);
    })
    .catch(console.log);
};
const handleCancel = () => {
  formRef.value.resetFields();
  open.value = false;
};
const startX = ref(0);
const startY = ref(0);
const startedDrag = ref(false);
const transformX = ref(0);
const transformY = ref(0);
const preTransformX = ref(0);
const preTransformY = ref(0);
const dragRect = ref({
  left: 0,
  right: 0,
  top: 0,
  bottom: 0,
});
watch([x, y], () => {
  if (!startedDrag.value) {
    startX.value = x.value;
    startY.value = y.value;
    const bodyRect = document.body.getBoundingClientRect();
    const titleRect = modalTitleRef.value.getBoundingClientRect();
    dragRect.value.right = bodyRect.width - titleRect.width;
    dragRect.value.bottom = bodyRect.height - titleRect.height;
    preTransformX.value = transformX.value;
    preTransformY.value = transformY.value;
  }
  startedDrag.value = true;
});
watch(isDragging, () => {
  if (!isDragging) {
    startedDrag.value = false;
  }
});
watchEffect(() => {
  if (startedDrag.value) {
    transformX.value =
      preTransformX.value +
      Math.min(Math.max(dragRect.value.left, x.value), dragRect.value.right) -
      startX.value;
    transformY.value =
      preTransformY.value +
      Math.min(Math.max(dragRect.value.top, y.value), dragRect.value.bottom) -
      startY.value;
  }
});
const transformStyle = computed(() => {
  return {
    transform: `translate(${transformX.value}px, ${transformY.value}px)`,
  };
});

//Form Component
const layout = {
  labelCol: {
    span: 8,
  },
  wrapperCol: {
    span: 16,
  },
};
const validateMessages = {
  required: "${label} is required!",
  types: {
    email: "${label} is not a valid email!",
  },
  date: {
    format: "'${name}' is invalid for format date",
    parse: "'${name}' could not be parsed as date",
    invalid: "'${name}' is invalid date",
  },
  whitespace: "Name cannot be empty",
};
const formState = reactive({
  user: {
    name: "1",
    email: "1@qq.com",
    capsuleText: "Hello",
    SubmitToTimeline: false,
    publishDate: null,
  },
});

console.log(formState);

//Upload Module
const fileList = ref([]);
const handleChange = (info) => {
  // console.log(info, fileList.value)
  console.log(info);
  const status = info.file.status;
  // info
  // if (status !== "uploading") {
  //   // console.log(info.file, info.fileList);
  // }
  if (status === "done") {
    console.log(info);
    // Callback on Success
    message.success(`${info.file.name} file uploaded successfully.`);
  } else if (status === "error") {
    message.error(`${info.file.name} file upload failed.`);
    fileList.value = fileList.value.filter((file) => file.status !== "error");
  }
};

function handleDrop(e) {
  console.log("At dropping");
  // console.log("Droping:"+ e);
  // console.log("Filelist" + fileList);
}
const beforeUpload = (file) => {
  const acceptedFileType = [
    "image/png",
    "image/jpg",
    "image/jpeg",
    "application/x-bzip",
    "application/zip",
  ];

  const valideFileType = acceptedFileType.includes(file.type);
  if (!valideFileType) {
    message.error(`${file.name} is not a supported file type`);
    return Upload.LIST_IGNORE;
  }
  const sizeLimit = 5;
  const isSmallerThanLimit = file.size / 1024 / 1024 < sizeLimit;
  if (!isSmallerThanLimit) {
    message.error(`Image must smaller than ${sizeLimit} MB!`);
    return Upload.LIST_IGNORE;
  }

  console.log(valideFileType || isSmallerThanLimit);
  //限制上传数量
  // console.log(fileList.value.length);
  if (fileList.value.length >= 3) {
    message.error(`${file.name} upload failed, Maximum 3 file`);
    return Upload.LIST_IGNORE;
  }

  return valideFileType || isSmallerThanLimit || Upload.LIST_IGNORE;
};
//调试
const onFinish = (values) => {
  console.log("Success:", values);
};
const onFinishFailed = (errorInfo) => {
  console.log("Failed:", errorInfo);
};
const router = useRouter();

function goToLogin() {
  router.push({ name: "Login" });
}
//submit disable without required input
const disabled = computed(() => {
  return !(formState.user.name && formState.user.email);
});
</script>

<style scoped>
:root {
  --mainpage-width: 1650px;
  --timeline-width:1350px
}
main {
  width: var(--mainpage-width);
  /* margin: 0 auto; */
  padding-left: 10px;
  display: flex;
  justify-content: space-between;
}
.container {
  width: var(--timeline-width);
  padding: 0;
  box-sizing: border-box;
}
.right {
  /* width: calc(1650px - 950px); */
  flex: 1;
  min-width: 370px;
  /* background-size: cover; */
}
.right .rightImage-wrapper {
  position: relative;
}
.right .button {
  position: absolute;
  bottom: 10px; /* Adjust this value to position the button */
  left: 120px; /* Adjust this value to position the button */
  display: flex;
  flex-direction: column;
  gap: 10px; /* Adjust this value for spacing between buttons */
  
  /* margin-top: 20px;
  width: 100px;
  height: 35px;
  border-radius: 5px;
 
  font-size: 16px;
  cursor: pointer; */
}

.timeline-options {
  display: flex;
  justify-content: flex-end; /* 保持内容在右侧 */
}

.timeline-controls {
  display: flex;
}

/* Timeline style */
img {
  display: block;
  object-fit: cover;
}
.content {
  text-wrap: wrap;
  word-break: break-all;
}
.container .timeContentPar {
  padding: 0 10px;
  width: 100%;
  height: 500px;
  padding-bottom: 10px;
  display: flex;
  align-items: flex-end;
  background-image: url("../assets/TimelineBackground/TimelineBackground1.png");
}
.container .timeContentPar .box {
  display: flex;
}
.container .timeContent {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: flex-end;
}

.container .timeContent .item {
  /* min-width: 220px; */
  width: 220px;
  color: #fff;
  padding-left: 15px;
}

.container .timeContent .type1 {
  background-color: #738d78;
  padding-left: 15px;
}

.container .timeContent .type1 .img {
  width: 100%;
  background-color: #fff;
  margin: 0;
}

.container .timeContent .type1 .text {
  background-color: #fff;
  padding-top: 5px;
}

.container .timeContent .type1 > .text .title {
  position: relative;
  left: -2px;
  background-color: #fff;
  font-size: 17px;
  padding: 6px;
  color: #000;
  text-align: center;
  font-weight: 400;
  width: 100%;
  border: 2px solid #70888f;
  margin: 0 0;
}

.container .timeContent .type1 > .text .content {
  font-size: 13px;
  color: #000;
  line-height: 16px;
  margin: 0px;
  padding: 10px;
  padding-bottom: 20px;
  padding-top: 5px;
}

.container .timeContent .item:not(:last-child) {
  margin-right: 15px;
}

.container .timeContent .type2 {
  padding-left: 0px;
}

.container .timeContent .type2 .img {
  background-color: #894060;
  padding-left: 10px;
}

.container .timeContent .type2 .img img {
  display: block;
}

.container .timeContent .type2 .text .content {
  background-color: #baa758;
  margin: 5px 0;
  font-size: 13px;
  padding: 10px;
}

.container .timeContent .type3 .img {
  padding-left: 10px;
  background-color: #bca854;
  height: 200px;
  display: flex;
  margin-top: 10px;
}

.container .timeContent .type3 .img img {
  width: 50%;
}

.container .timeContent .type3 .img .text {
  width: 50%;
  background-color: #fff;
  color: #000;
  padding: 5px 10px;
}

.container .timeContent .type3 .img .text .title {
  font-size: 14px;
  font-weight: 500;
  margin: 0;
}

.container .timeContent .type3 .img .text .content {
  font-size: 13px;
  margin: 0;
}
.container .timeContent .type3 > .text {
  background-color: #bca854;
  padding-left: 10px;
}
.container .timeContent .type3 > .text .title {
  position: relative;
  left: -2px;
  background-color: #fff;
  font-size: 17px;
  padding: 6px;
  color: #000;
  text-align: center;
  font-weight: 400;
  width: 100%;
  border: 2px solid #70888f;
  margin: 0 0;
}
</style>